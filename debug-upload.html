<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        textarea { width: 100%; height: 100px; }
    </style>
</head>
<body>
    <h1>Upload Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Authentication Check</h3>
        <div id="authStatus"></div>
        <button onclick="checkAuth()">Check Authentication</button>
    </div>
    
    <div class="debug-section">
        <h3>Server Connection Test</h3>
        <div id="serverStatus"></div>
        <button onclick="testServer()">Test Server Connection</button>
    </div>
    
    <div class="debug-section">
        <h3>Upload Test</h3>
        <form id="uploadForm">
            <input type="file" id="image" accept="image/*" required><br><br>
            <textarea id="caption" placeholder="Caption (optional)"></textarea><br><br>
            <input type="checkbox" id="isPrivate"> Private Post<br><br>
            <button type="submit">Upload Test</button>
        </form>
        <div id="uploadResult"></div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const authDiv = document.getElementById('authStatus');
            
            if (!token) {
                authDiv.innerHTML = '<span class="error">❌ No token found - User not logged in</span>';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                authDiv.innerHTML = `
                    <span class="success">✅ Token found</span><br>
                    <span class="info">User ID: ${payload.id}</span><br>
                    <span class="info">Username: ${payload.username}</span><br>
                    <span class="info">Token expires: ${new Date(payload.exp * 1000).toLocaleString()}</span>
                `;
            } catch (error) {
                authDiv.innerHTML = `<span class="error">❌ Invalid token: ${error.message}</span>`;
            }
        }
        
        // Test server connection
        async function testServer() {
            const serverDiv = document.getElementById('serverStatus');
            serverDiv.innerHTML = '<span class="info">Testing server connection...</span>';
            
            try {
                const response = await fetch('/api/feed', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                
                if (response.ok) {
                    serverDiv.innerHTML = '<span class="success">✅ Server is responding</span>';
                } else {
                    serverDiv.innerHTML = `<span class="error">❌ Server error: ${response.status}</span>`;
                }
            } catch (error) {
                serverDiv.innerHTML = `<span class="error">❌ Connection failed: ${error.message}</span>`;
            }
        }
        
        // Upload test
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = '<span class="info">Uploading...</span>';
            
            const file = document.getElementById('image').files[0];
            if (!file) {
                resultDiv.innerHTML = '<span class="error">❌ Please select a file</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('caption', document.getElementById('caption').value);
            formData.append('isPrivate', document.getElementById('isPrivate').checked);
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <span class="success">✅ Upload successful!</span><br>
                        <span class="info">File: ${data.file.filename}</span><br>
                        <span class="info">Caption: ${data.file.caption || 'None'}</span><br>
                        <span class="info">Private: ${data.file.isPrivate}</span>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ Upload failed</span><br>
                        <span class="error">Status: ${response.status}</span><br>
                        <span class="error">Message: ${data.message}</span><br>
                        <span class="error">Error: ${data.error || 'Unknown error'}</span>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Network error: ${error.message}</span>`;
            }
        });
        
        // Auto-check auth on load
        checkAuth();
    </script>
</body>
</html> 